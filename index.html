<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacaciones Metal 2026 | Sistema de Gestión</title>
    
    <!-- Fuentes y Librerías Externas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-page: #f8fafc;
            --sidebar-w: 300px;
        }
        
        body { 
            background-color: var(--bg-page); 
            font-family: 'Inter', sans-serif; 
            font-size: 14px;
            color: #1e293b;
        }

        /* Pantalla de Login */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
        }

        /* Contenedor Principal */
        .app-container {
            display: none; /* Oculto hasta login */
            grid-template-columns: var(--sidebar-w) 1fr;
            min-height: 100vh;
        }

        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
        }

        /* Estilos Sidebar */
        .sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            padding: 1.5rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        /* Estilos Calendario */
        .calendar-wrapper {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        #calendar {
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        /* Tablas */
        .summary-table {
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .summary-table th {
            background: #f1f5f9;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
        }

        .summary-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #f1f5f9;
        }

        /* FullCalendar Tweaks */
        .fc { --fc-border-color: #f1f5f9; font-size: 0.75rem; }
        .fc .fc-toolbar-title { font-weight: 700; color: #0f172a; font-size: 1.25rem !important; }
        .fc-multimonth-header { background: #f8fafc; padding: 6px !important; border-radius: 4px; }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; }
        
        .btn-primary {
            background: #0f172a; color: white; padding: 0.6rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary:hover { background: #334155; }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="loginScreen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900">Acceso Privado</h2>
                <p class="text-slate-500 mt-2">Gestión de Vacaciones 2026</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1 text-slate-700">Usuario</label>
                    <input type="text" id="username" class="w-full border border-slate-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1 text-slate-700">Contraseña</label>
                    <input type="password" id="password" class="w-full border border-slate-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Entrar al Sistema</button>
                <p id="loginError" class="text-red-500 text-xs text-center hidden">Credenciales incorrectas. Intente de nuevo.</p>
            </form>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="app-container" id="mainApp">
        
        <!-- Sidebar -->
        <aside class="sidebar space-y-6">
            <div class="mb-8">
                <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">Vacaciones<span class="text-blue-600">2026</span></h1>
                <p class="text-xs text-slate-500 font-medium uppercase tracking-widest mt-1">Metal Torrelavega</p>
            </div>

            <div class="space-y-4">
                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Empleado Activo</label>
                    <select id="empSelector" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none">
                        <optgroup label="Grupo 1 (Taller)">
                            <option value="Igor Santamaría">Igor Santamaría</option>
                            <option value="Adrian">Adrian</option>
                            <option value="Nacho Galán">Nacho Galán</option>
                        </optgroup>
                        <optgroup label="Grupo 2 (Oficina)">
                            <option value="Jesus Fernández">Jesus Fernández</option>
                            <option value="Luis Portilla">Luis Portilla</option>
                            <option value="Jorge Barreda">Jorge Barreda</option>
                        </optgroup>
                    </select>
                </div>

                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Saldos Restantes</label>
                    <div id="statsContainer" class="space-y-4"></div>
                </div>

                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Leyenda</label>
                    <div id="legendContainer" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <button id="btnExport" class="btn-primary w-full mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Generar Reporte PDF
            </button>
            
            <button id="btnLogout" class="w-full text-slate-400 text-xs font-bold uppercase hover:text-red-500 transition-colors mt-2">Cerrar Sesión</button>
        </aside>

        <!-- Main Content -->
        <main class="calendar-wrapper">
            <header class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                    <button id="btnPrev" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <span id="currentYearDisplay" class="font-bold text-slate-700 px-4">2026</span>
                    <button id="btnNext" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button id="btnViewYear" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold hover:bg-slate-50 shadow-sm transition">Anual</button>
                    <button id="btnViewMonth" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold hover:bg-slate-50 shadow-sm transition">Mensual</button>
                </div>
            </header>

            <!-- Calendario -->
            <div id='calendar'></div>

            <!-- Tabla Resumen -->
            <section class="mt-8">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="9" y1="4" x2="9" y2="20"/></svg>
                    Tabla Resumen de Periodos
                </h3>
                <div class="summary-table overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                <th>Grupo</th>
                                <th>Desde</th>
                                <th>Hasta</th>
                                <th>Días Lab.</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- JS inyectará filas aquí -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <footer class="mt-12 text-center text-slate-400 text-xs pb-8">
                © 2026 Metalúrgica Torrelavega - Panel de Control Administrativo
            </footer>
        </main>

    </div>

    <script>
        // --- DATA ESTATICA ---
        const FESTIVOS_2026 = [
            "2026-01-01", "2026-01-06", "2026-04-02", "2026-04-03", 
            "2026-05-01", "2026-07-25", "2026-08-15", "2026-09-16", 
            "2026-11-01", "2026-12-06", "2026-12-08", "2026-12-25"
        ];

        const EMPLEADOS = [
            { nombre: "Igor Santamaría", grupo: "G1", color: "#1e40af" }, 
            { nombre: "Adrian", grupo: "G1", color: "#3b82f6" },          
            { nombre: "Nacho Galán", grupo: "G1", color: "#60a5fa" },      
            { nombre: "Jesus Fernández", grupo: "G2", color: "#065f46" }, 
            { nombre: "Luis Portilla", grupo: "G2", color: "#10b981" },    
            { nombre: "Jorge Barreda", grupo: "G2", color: "#34d399" }     
        ];

        let vacaciones = JSON.parse(localStorage.getItem('vacaciones_2026')) || [];
        let calendar;

        // --- MANEJO DE LOGIN ---
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === 'metal2026') {
                sessionStorage.setItem('isLogged', 'true');
                iniciarApp();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        if(sessionStorage.getItem('isLogged') === 'true') iniciarApp();

        function iniciarApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'grid';
            renderCalendar();
            actualizarUI();
        }

        document.getElementById('btnLogout').onclick = () => {
            sessionStorage.clear();
            location.reload();
        };

        // --- LOGICA DE NEGOCIO ---
        const esLaborable = (f) => {
            const d = new Date(f);
            const s = d.toISOString().split('T')[0];
            return d.getDay() !== 0 && d.getDay() !== 6 && !FESTIVOS_2026.includes(s);
        };

        const contarLaborables = (s, e) => {
            let c = 0; let cur = new Date(s); let stop = new Date(e);
            while (cur < stop) { if (esLaborable(cur)) c++; cur.setDate(cur.getDate() + 1); }
            return c;
        };

        function actualizarUI() {
            const stats = document.getElementById('statsContainer');
            const legend = document.getElementById('legendContainer');
            const tableBody = document.getElementById('tableBody');
            
            stats.innerHTML = ''; legend.innerHTML = ''; tableBody.innerHTML = '';
            
            // Ordenar vacaciones para la tabla por fecha de inicio
            const vacacionesSorted = [...vacaciones].sort((a,b) => new Date(a.start) - new Date(b.start));

            EMPLEADOS.forEach(emp => {
                const misVacas = vacaciones.filter(v => v.title === emp.nombre);
                const diasGastados = misVacas.reduce((total, v) => total + contarLaborables(v.start, v.end), 0);
                const restantes = 22 - diasGastados;
                const porcentaje = (diasGastados / 22) * 100;

                stats.innerHTML += `
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="font-bold text-slate-700">${emp.nombre}</span>
                            <span class="${restantes < 5 ? 'text-red-500 font-bold' : 'text-slate-400'}">${restantes} r.</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="h-1.5 rounded-full transition-all duration-700" style="width: ${Math.min(porcentaje, 100)}%; background-color: ${emp.color}"></div>
                        </div>
                    </div>`;

                legend.innerHTML += `
                    <div class="flex items-center gap-2">
                        <span class="status-dot" style="background-color: ${emp.color}"></span>
                        <span class="text-slate-600">${emp.nombre}</span>
                    </div>`;
            });

            // Llenar tabla resumen
            vacacionesSorted.forEach(v => {
                const emp = EMPLEADOS.find(e => e.nombre === v.title);
                const dias = contarLaborables(v.start, v.end);
                tableBody.innerHTML += `
                    <tr class="text-xs hover:bg-slate-50 transition-colors">
                        <td class="font-bold text-slate-700">${v.title}</td>
                        <td><span class="px-2 py-0.5 rounded-full text-[10px] bg-slate-100 text-slate-500 font-bold">${emp.grupo}</span></td>
                        <td>${v.start}</td>
                        <td>${v.end}</td>
                        <td class="font-semibold text-blue-600">${dias} d</td>
                        <td>
                            <button onclick="borrarVacacion('${v.id}')" class="text-red-400 hover:text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        window.borrarVacacion = (id) => {
            if(confirm('¿Eliminar este periodo?')) {
                vacaciones = vacaciones.filter(v => v.id !== id);
                localStorage.setItem('vacaciones_2026', JSON.stringify(vacaciones));
                calendar.getEventById(id).remove();
                actualizarUI();
            }
        };

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridYear',
                initialDate: '2026-01-01',
                locale: 'es',
                firstDay: 1,
                height: 'auto',
                selectable: true,
                multiMonthMaxColumns: 4,
                headerToolbar: false,
                events: [
                    ...FESTIVOS_2026.map(f => ({ title: 'F', start: f, allDay: true, display: 'background' })),
                    ...vacaciones
                ],
                select: function(info) {
                    const nombre = document.getElementById('empSelector').value;
                    const empData = EMPLEADOS.find(e => e.nombre === nombre);
                    const dias = contarLaborables(info.start, info.end);

                    if (dias === 0) { calendar.unselect(); return; }

                    const gastados = vacaciones.filter(v => v.title === nombre).reduce((t,v) => t + contarLaborables(v.start, v.end), 0);
                    if (gastados + dias > 22) {
                        alert(`Límite excedido para ${nombre}`);
                        calendar.unselect(); return;
                    }

                    const conflicto = vacaciones.some(v => {
                        const vEmp = EMPLEADOS.find(e => e.nombre === v.title);
                        return vEmp.grupo === empData.grupo && info.start < new Date(v.end) && info.end > new Date(v.start);
                    });

                    if (conflicto) {
                        alert(`Conflicto Grupo ${empData.grupo}`);
                        calendar.unselect(); return;
                    }

                    const nuevo = { id: Date.now().toString(), title: nombre, start: info.startStr, end: info.endStr, color: empData.color, allDay: true };
                    vacaciones.push(nuevo);
                    localStorage.setItem('vacaciones_2026', JSON.stringify(vacaciones));
                    calendar.addEvent(nuevo);
                    actualizarUI();
                    calendar.unselect();
                },
                eventClick: (info) => borrarVacacion(info.event.id)
            });
            calendar.render();
        }

        // Controles Navegación
        document.getElementById('btnNext').onclick = () => calendar.next();
        document.getElementById('btnPrev').onclick = () => calendar.prev();
        document.getElementById('btnViewYear').onclick = () => calendar.changeView('dayGridYear');
        document.getElementById('btnViewMonth').onclick = () => calendar.changeView('dayGridMonth');

        document.getElementById('btnExport').onclick = function() {
            const element = document.querySelector('.calendar-wrapper');
            html2pdf().from(element).set({
                margin: 10, filename: 'Resumen_Vacaciones_2026.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).save();
        };
    </script>
</body>
</html>