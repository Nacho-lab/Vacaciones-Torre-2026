<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacaciones Metal 2026 | Sistema de Gestión</title>
    
    <!-- Fuentes y Librerías Externas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --bg-page: #f8fafc;
            --sidebar-w: 300px;
        }
        
        body { 
            background-color: var(--bg-page); 
            font-family: 'Inter', sans-serif; 
            font-size: 14px;
            color: #1e293b;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
        }

        .app-container {
            display: none; 
            grid-template-columns: var(--sidebar-w) 1fr;
            min-height: 100vh;
        }

        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
        }

        .sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            padding: 1.5rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .calendar-wrapper {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        #calendar {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .summary-table {
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .summary-table th {
            background: #f1f5f9;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
        }

        .summary-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #f1f5f9;
        }

        .fc .fc-toolbar-title { font-weight: 700; color: #0f172a; font-size: 1.25rem !important; }
        .fc-multimonth-header { background: #f8fafc; padding: 6px !important; border-radius: 4px; }
        .fc-multimonth-title { font-weight: 700 !important; color: #1e293b !important; text-transform: capitalize; }
        .fc-daygrid-day-number { font-size: 0.8rem; color: #64748b; }
        
        .fc-event { border: none !important; border-radius: 3px !important; padding: 1px 3px !important; cursor: pointer; }

        .card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; }
        
        .btn-primary {
            background: #0f172a; color: white; padding: 0.6rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary:hover { background: #334155; }

        .btn-outline {
            background: transparent; border: 1px solid #e2e8f0; color: #475569; padding: 0.6rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-outline:hover { background: #f8fafc; border-color: #cbd5e1; }

        .active-view { background-color: #3b82f6 !important; color: white !important; border-color: #2563eb !important; }

        /* Panel Historial lateral (Drawer) */
        #historyDrawer {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -10px 0 25px -5px rgba(0,0,0,0.1);
            z-index: 10001;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #historyDrawer.open { right: 0; }
        
        #historyOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
        }

        .history-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .history-item:hover { background: #f8fafc; }

        #selectionModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        #syncIndicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 99px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 100;
        }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="loginScreen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900">Acceso Privado</h2>
                <p class="text-slate-500 mt-2">Gestión de Vacaciones 2026</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1 text-slate-700">Usuario</label>
                    <input type="text" id="username" class="w-full border border-slate-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1 text-slate-700">Contraseña</label>
                    <input type="password" id="password" class="w-full border border-slate-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Entrar al Sistema</button>
                <p id="loginError" class="text-red-500 text-xs text-center hidden">Credenciales incorrectas.</p>
            </form>
        </div>
    </div>

    <!-- Modal de Selección de Jornada -->
    <div id="selectionModal">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80 space-y-4">
            <h3 class="font-bold text-slate-800 text-lg">Tipo de Jornada</h3>
            <p class="text-xs text-slate-500">Selecciona cómo quieres imputar estos días:</p>
            <div class="grid grid-cols-1 gap-2">
                <button onclick="window.confirmarSeleccion('completo')" class="w-full text-left p-3 border rounded-lg hover:bg-slate-50 flex justify-between items-center">
                    <span>Día Completo</span>
                    <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">1.0</span>
                </button>
                <button onclick="window.confirmarSeleccion('mañana')" class="w-full text-left p-3 border rounded-lg hover:bg-slate-50 flex justify-between items-center">
                    <span>Mañana (M)</span>
                    <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">0.5</span>
                </button>
                <button onclick="window.confirmarSeleccion('tarde')" class="w-full text-left p-3 border rounded-lg hover:bg-slate-50 flex justify-between items-center">
                    <span>Tarde (T)</span>
                    <span class="text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold">0.5</span>
                </button>
            </div>
            <button onclick="window.cerrarModal()" class="w-full py-2 text-slate-400 text-xs font-bold uppercase hover:text-slate-600">Cancelar</button>
        </div>
    </div>

    <!-- Historial Lateral (Drawer) -->
    <div id="historyOverlay" onclick="window.toggleHistory(false)"></div>
    <div id="historyDrawer">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-800">Historial de Cambios</h2>
            <button onclick="window.toggleHistory(false)" class="text-slate-400 hover:text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto">
            <!-- Items de historial cargados dinámicamente -->
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-100">
            <p class="text-[10px] text-slate-400 text-center uppercase font-bold tracking-wider">Registro centralizado en la nube</p>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <aside class="sidebar space-y-6">
            <div class="mb-4">
                <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">Vacaciones<span class="text-blue-600">2026</span></h1>
                <p class="text-xs text-slate-500 font-medium uppercase tracking-widest mt-1">Central de Torrelavega</p>
            </div>

            <div class="flex-1 space-y-4 overflow-y-auto pr-2">
                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Empleado Activo</label>
                    <select id="empSelector" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <optgroup label="Grupo 1 (Taller)">
                            <option value="Igor Santamaría">Igor Santamaría</option>
                            <option value="Adrian">Adrian</option>
                            <option value="Nacho Galán">Nacho Galán</option>
                        </optgroup>
                        <optgroup label="Grupo 2 (Oficina)">
                            <option value="Jesus Fernández">Jesus Fernández</option>
                            <option value="Luis Portilla">Luis Portilla</option>
                            <option value="Jorge Barreda">Jorge Barreda</option>
                        </optgroup>
                    </select>
                </div>

                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Saldos Restantes (Máx 25 d.)</label>
                    <div id="statsContainer" class="space-y-4"></div>
                </div>

                <button onclick="window.toggleHistory(true)" class="btn-outline w-full group">
                    <svg class="group-hover:rotate-12 transition-transform" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-9-9 8.95 8.95 0 0 1 5.9 2.2L21 8M21 3v5h-5"/></svg>
                    Ver Historial de Cambios
                </button>

                <div class="card">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Leyenda</label>
                    <div id="legendContainer" class="space-y-2 text-xs"></div>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100 space-y-2">
                <button id="btnExport" class="btn-primary w-full shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    Generar PDF
                </button>
                <button id="btnLogout" class="w-full text-slate-400 text-[10px] font-bold uppercase hover:text-red-500 transition-colors py-2">Cerrar Sesión</button>
            </div>
        </aside>

        <main class="calendar-wrapper">
            <header class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                    <button id="btnPrev" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">←</button>
                    <span id="currentDateDisplay" class="font-bold text-slate-700 px-4 min-w-[100px] text-center">2026</span>
                    <button id="btnNext" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">→</button>
                </div>
                <div class="flex gap-2 p-1 bg-white border border-slate-200 rounded-xl shadow-sm">
                    <button id="btnViewYear" class="px-4 py-2 rounded-lg text-sm font-semibold active-view transition-all">Anual</button>
                    <button id="btnViewMonth" class="px-4 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all">Mensual</button>
                </div>
            </header>

            <div id='calendar'></div>

            <section class="mt-8">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
                    Tabla Resumen de Asignaciones
                </h3>
                <div class="summary-table overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Empleado</th><th>Grupo</th><th>Desde</th><th>Hasta</th><th>Tipo</th><th>Días</th><th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Indicador de Sincronización -->
    <div id="syncIndicator">
        <span id="syncStatusDot" class="w-2 h-2 rounded-full bg-orange-400"></span>
        <span id="syncText">Configurando Firebase...</span>
    </div>

    <!-- Firebase y Lógica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================================
        // CONFIGURACIÓN PARA GITHUB / PRODUCCIÓN
        // ==========================================================
        const manualFirebaseConfig = {
            apiKey: "AIzaSyB3yRAv83hjwy_6jRqGzj2AzZ-V2iQ4iy0",
            authDomain: "vacaciones-torrelavega.firebaseapp.com",
            projectId: "vacaciones-torrelavega",
            storageBucket: "vacaciones-torrelavega.firebasestorage.app",
            messagingSenderId: "77778108267",
            appId: "1:77778108267:web:e942576bb82be5c3bf562e",
            measurementId: "G-36DTZV323K"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined') 
            ? JSON.parse(__firebase_config) 
            : manualFirebaseConfig;
            
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'mi-app-vacaciones-metal';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==========================================================

        let currentUser = null;
        let vacaciones = [];
        let calendar = null;
        let tempSelection = null;
        let unsubVacations = null;
        let unsubHistory = null;

        const FESTIVOS_2026 = [
            "2026-01-01", "2026-01-06", "2026-04-02", "2026-04-03", 
            "2026-05-01", "2026-07-25", "2026-08-15", "2026-09-15", 
            "2026-09-16", "2026-11-01", "2026-12-06", "2026-12-08", 
            "2026-12-24", "2026-12-25", "2026-12-31", "2026-09-17" 
        ];
        
        const MAX_DIAS_VACACIONES = 25;

        const EMPLEADOS = [
            { nombre: "Igor Santamaría", grupo: "G1", color: "#1e40af" }, 
            { nombre: "Adrian", grupo: "G1", color: "#3b82f6" },          
            { nombre: "Nacho Galán", grupo: "G1", color: "#60a5fa" },      
            { nombre: "Jesus Fernández", grupo: "G2", color: "#065f46" }, 
            { nombre: "Luis Portilla", grupo: "G2", color: "#10b981" },    
            { nombre: "Jorge Barreda", grupo: "G2", color: "#34d399" }     
        ];

        // --- FUNCIONES GLOBALES ---
        window.toggleHistory = (open) => {
            const drawer = document.getElementById('historyDrawer');
            const overlay = document.getElementById('historyOverlay');
            if(open) {
                drawer.classList.add('open');
                overlay.style.display = 'block';
            } else {
                drawer.classList.remove('open');
                overlay.style.display = 'none';
            }
        };

        window.cerrarModal = () => {
            document.getElementById('selectionModal').style.display = 'none';
            tempSelection = null;
            if (calendar) calendar.unselect();
        };

        window.confirmarSeleccion = async (tipo) => {
            if(!tempSelection || !currentUser) return;
            const { info, empData, nombre } = tempSelection;
            let factor = (tipo === 'completo') ? 1 : 0.5;
            let labelSuffix = (tipo === 'mañana') ? ' (M)' : (tipo === 'tarde') ? ' (T)' : '';
            const diasLaborables = contarLaborables(info.start, info.end, factor);

            const gastados = vacaciones.filter(v => v.title.startsWith(nombre)).reduce((t,v) => t + v.valorTotal, 0);
            if (gastados + diasLaborables > MAX_DIAS_VACACIONES) { 
                alert(`Este empleado no tiene suficientes días restantes.`); 
                window.cerrarModal(); return; 
            }

            const nuevo = { 
                id: Date.now().toString(), 
                title: nombre + labelSuffix, 
                start: info.startStr, 
                end: info.endStr, 
                color: empData.color, 
                allDay: true,
                tipo: tipo,
                valorTotal: diasLaborables
            };

            await saveVacation(nuevo);
            window.cerrarModal();
        };

        const setSyncStatus = (type, text) => {
            const dot = document.getElementById('syncStatusDot');
            const label = document.getElementById('syncText');
            if (!dot || !label) return;
            label.innerText = text;
            if(type === 'online') dot.className = "w-2 h-2 rounded-full bg-green-500";
            else if(type === 'error') dot.className = "w-2 h-2 rounded-full bg-red-500";
            else dot.className = "w-2 h-2 rounded-full bg-orange-400 animate-pulse";
        };

        const esLaborable = (f) => {
            const d = new Date(f);
            const s = d.toISOString().split('T')[0];
            return d.getDay() !== 0 && d.getDay() !== 6 && !FESTIVOS_2026.includes(s);
        };

        const contarLaborables = (s, e, factor = 1) => {
            let c = 0; let cur = new Date(s); let stop = new Date(e);
            while (cur < stop) { if (esLaborable(cur)) c += factor; cur.setDate(cur.getDate() + 1); }
            return c;
        };

        // RUTAS CRÍTICAS (RULE 1)
        const getVacationsPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'vacaciones');
        const getHistoryPath = () => collection(db, 'artifacts', appId, 'public', 'data', 'history');

        async function saveVacation(v) {
            if(!currentUser) return;
            setSyncStatus('syncing', 'Guardando...');
            try {
                // RULE 1: Ruta exacta
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vacaciones', v.id), v);
                await logActivity('ASIGNACIÓN', `${v.title}: ${v.start} al ${v.end} (${v.valorTotal}d)`);
            } catch (e) {
                console.error("Save Error:", e);
                setSyncStatus('error', 'Error al guardar');
            }
        }

        async function deleteVacation(vId) {
            if(!currentUser) return;
            const vData = vacaciones.find(v => v.id === vId);
            if(!vData) return;
            
            if(confirm(`¿Deseas eliminar las vacaciones de ${vData.title}?`)) {
                setSyncStatus('syncing', 'Eliminando...');
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vacaciones', vId));
                    await logActivity('ELIMINACIÓN', `${vData.title}: del ${vData.start} al ${vData.end}`);
                } catch (e) {
                    console.error("Delete Error:", e);
                    setSyncStatus('error', 'Error al eliminar');
                }
            }
        }

        async function logActivity(accion, detalle) {
            if(!currentUser) return;
            const logId = Date.now().toString();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', logId), {
                    accion, detalle, 
                    timestamp: Date.now(),
                    fecha: new Date().toLocaleString()
                });
            } catch (e) {}
        }

        function actualizarUI() {
            const stats = document.getElementById('statsContainer');
            const legend = document.getElementById('legendContainer');
            const tableBody = document.getElementById('tableBody');
            if(!stats || !legend || !tableBody) return;
            
            stats.innerHTML = ''; legend.innerHTML = ''; tableBody.innerHTML = '';
            const vacacionesSorted = [...vacaciones].sort((a,b) => new Date(a.start) - new Date(b.start));

            EMPLEADOS.forEach(emp => {
                const misVacas = vacaciones.filter(v => v.title && v.title.startsWith(emp.nombre));
                const diasGastados = misVacas.reduce((total, v) => total + v.valorTotal, 0);
                const restantes = MAX_DIAS_VACACIONES - diasGastados;
                const porcentaje = (diasGastados / MAX_DIAS_VACACIONES) * 100;

                stats.innerHTML += `
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="font-bold text-slate-700">${emp.nombre}</span>
                            <span class="${restantes < 5 ? 'text-red-500 font-bold' : 'text-slate-400'}">${restantes.toFixed(1)} rest.</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="h-1.5 rounded-full transition-all duration-700" style="width: ${Math.min(porcentaje, 100)}%; background-color: ${emp.color}"></div>
                        </div>
                    </div>`;

                legend.innerHTML += `
                    <div class="flex items-center gap-2">
                        <span class="status-dot" style="background-color: ${emp.color}"></span>
                        <span class="text-slate-600">${emp.nombre}</span>
                    </div>`;
            });

            vacacionesSorted.forEach(v => {
                const emp = EMPLEADOS.find(e => v.title && v.title.startsWith(e.nombre));
                const row = document.createElement('tr');
                row.className = "text-xs hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="font-bold text-slate-700 p-3">${v.title || 'S/N'}</td>
                    <td><span class="px-2 py-0.5 rounded-full text-[10px] bg-slate-100 text-slate-500 font-bold">${emp ? emp.grupo : '-'}</span></td>
                    <td>${v.start}</td><td>${v.end}</td>
                    <td><span class="capitalize text-[10px] font-medium text-slate-400">${v.tipo || 'Completo'}</span></td>
                    <td class="font-semibold text-blue-600">${(v.valorTotal || 0).toFixed(1)} d</td>
                    <td>
                        <button class="delete-action text-red-400 hover:text-red-600 text-[10px] font-bold uppercase p-1">Eliminar</button>
                    </td>
                `;
                row.querySelector('.delete-action').onclick = () => deleteVacation(v.id);
                tableBody.appendChild(row);
            });
        }

        function renderHistorico(historico) {
            const list = document.getElementById('historyList');
            if (!list) return;
            if (historico.length === 0) {
                list.innerHTML = '<div class="p-12 text-center text-slate-300 italic">No hay registros de actividad todavía.</div>';
                return;
            }
            list.innerHTML = historico.map(item => `
                <div class="history-item">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-black uppercase tracking-tighter ${item.accion === 'ELIMINACIÓN' ? 'text-red-500' : 'text-blue-600'}">${item.accion}</span>
                        <span class="text-[9px] text-slate-400 font-medium">${item.fecha}</span>
                    </div>
                    <div class="text-xs text-slate-700 font-medium leading-relaxed">${item.detalle}</div>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl || calendar) return; // Evitar doble renderizado
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'multiMonthYear',
                initialDate: '2026-01-01',
                locale: 'es',
                firstDay: 1,
                height: 'auto',
                selectable: true,
                multiMonthMaxColumns: 4,
                headerToolbar: false,
                events: FESTIVOS_2026.map(f => ({ title: 'F', start: f, allDay: true, display: 'background', backgroundColor: '#fee2e2' })),
                datesSet: () => {
                    const disp = document.getElementById('currentDateDisplay');
                    if (disp) disp.innerText = calendar.view.title;
                },
                select: function(info) {
                    const nombre = document.getElementById('empSelector').value;
                    const empData = EMPLEADOS.find(e => e.nombre === nombre);
                    if (contarLaborables(info.start, info.end, 1) === 0) { calendar.unselect(); return; }
                    tempSelection = { info, empData, nombre };
                    document.getElementById('selectionModal').style.display = 'flex';
                },
                eventClick: (info) => {
                    if (info.event.display !== 'background') deleteVacation(info.event.id);
                }
            });
            calendar.render();
            vacaciones.forEach(v => calendar.addEvent(v));
        }

        // RULE 3: Auth Before Queries
        const startSync = () => {
            if (!currentUser) return;

            // Limpiar suscripciones previas si existen
            if (unsubVacations) unsubVacations();
            if (unsubHistory) unsubHistory();

            unsubVacations = onSnapshot(getVacationsPath(), (snap) => {
                vacaciones = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (calendar) {
                    calendar.getEvents().forEach(e => { if(e.display !== 'background') e.remove(); });
                    vacaciones.forEach(v => calendar.addEvent(v));
                }
                actualizarUI();
                setSyncStatus('online', 'En línea (Sincronizado)');
            }, (error) => {
                console.error("Firestore Error (Vacations):", error);
                setSyncStatus('error', 'Error de permisos de lectura');
            });

            unsubHistory = onSnapshot(getHistoryPath(), (snap) => {
                const history = snap.docs.map(d => d.data()).sort((a,b) => b.timestamp - a.timestamp);
                renderHistorico(history);
            }, (error) => {
                console.error("Firestore Error (History):", error);
            });
        };

        // Listeners de UI
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === 'metal2026') {
                sessionStorage.setItem('isLogged', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'grid';
                if(!calendar) renderCalendar();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        document.getElementById('btnLogout').onclick = () => {
            sessionStorage.clear();
            location.reload();
        };

        document.getElementById('btnNext').onclick = () => calendar && calendar.next();
        document.getElementById('btnPrev').onclick = () => calendar && calendar.prev();
        document.getElementById('btnViewYear').onclick = function() { 
            if(!calendar) return;
            calendar.changeView('multiMonthYear'); 
            this.classList.add('active-view');
            document.getElementById('btnViewMonth').classList.remove('active-view');
        };
        document.getElementById('btnViewMonth').onclick = function() { 
            if(!calendar) return;
            calendar.changeView('dayGridMonth'); 
            this.classList.add('active-view');
            document.getElementById('btnViewYear').classList.remove('active-view');
        };

        document.getElementById('btnExport').onclick = () => {
            const element = document.querySelector('.calendar-wrapper');
            const opt = { 
                margin: 0.5, 
                filename: 'Vacaciones_Metal_2026.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2 }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' } 
            };
            html2pdf().set(opt).from(element).save();
        };

        // RULE 3 - CICLO DE VIDA DE AUTH (CRÍTICO)
        const initFirebase = async () => {
            setSyncStatus('syncing', 'Autenticando...');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                setSyncStatus('error', 'Error al conectar con el servidor');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                startSync();
                if(sessionStorage.getItem('isLogged') === 'true') {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'grid';
                    setTimeout(renderCalendar, 200);
                }
            } else {
                currentUser = null;
                setSyncStatus('offline', 'Desconectado');
            }
        });

        // Ejecución inicial
        window.onload = () => {
            initFirebase();
        };
    </script>
</body>
</html>